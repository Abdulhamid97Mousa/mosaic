# Day 10: BDI Mode Enable Solution

## Problem Summary

**User Report:** "the agent itself is not moving in the replay? there is nothing making the BDI-Based agent move or train even though I launched the Train Agent button"

**Root Cause Analysis:** 
The training infrastructure was working correctly, but workers were launching in **Headless/Q-Learning mode** instead of **BDI mode**. The critical missing piece was:

1. **NO UI option** to enable BDI mode in the training dialog
2. **NO BDI configuration** being passed from UI to training config
3. **NO dispatcher logic** to inject `--bdi` flag into worker subprocess command

Result: Workers always defaulted to `HeadlessTrainer` (vanilla Q-Learning), never `BDITrainer` (SPADE-based agent).

## Investigation Results

**Worker Process Inspection (from Phase 6):**
```bash
# Found running workers WITHOUT --bdi flag:
PID 1888759: /usr/bin/python -m spadeBDI_RL_refactored.worker \
    --config /path/b102b0320d105b5623a35ad828aee933ffb66975.json \
    --grpc --grpc-target 127.0.0.1:50055
    # MISSING: --bdi --bdi-jid agent@localhost --bdi-password secret
```

**Worker Code Analysis (spadeBDI_RL_refactored/worker.py):**
- Line 47: `--bdi` argument properly defined in parser
- Line 73-75: Correct logic checks `if parsed.bdi: trainer = BDITrainer() else: HeadlessTrainer()`
- **Issue:** Worker never receives `--bdi` flag, always defaults to HeadlessTrainer

**Configuration Flow Analysis:**
```
agent_train_dialog.py (NO BDI option in UI)
    ↓ _build_base_config() creates metadata without BDI settings
training_config.json (stored in database)
    ↓ metadata.worker section has NO bdi_enabled flag
dispatcher.py _build_worker_command()
    ↓ No code to read bdi_config or add --bdi flags
Worker subprocess command
    ✗ Missing: --bdi --bdi-jid --bdi-password
spadeBDI_RL_refactored/worker.py main()
    ↓ Receives no --bdi argument
    ✗ Defaults to HeadlessTrainer
    ✗ NO BDI AGENT EXECUTION
```

## Solution Implementation

### File 1: gym_gui/ui/widgets/agent_train_dialog.py

**Changes:**
1. Added "BDI Agent Settings (SPADE)" collapsible QGroupBox after algorithm selection
   - Checkbox to enable/disable BDI mode (default: unchecked)
   - QLineEdit for XMPP JID (default: "agent@localhost")
   - QLineEdit for XMPP password (default: "secret", shown as dots)
   - QLineEdit for ASL file path (optional) with "Browse..." button

2. Added `_on_browse_asl_file()` method
   - File dialog to select ASL beliefs file
   - Sets path to QLineEdit if selected

3. Modified `_build_base_config()` method
   - Reads BDI settings from UI widgets
   - Adds `bdi_enabled` flag to metadata.worker
   - Adds `bdi_config` dict with jid, password, optional asl_file
   - Adds BDI environment variables if enabled (BDI_ENABLED, BDI_JID, BDI_PASSWORD, BDI_ASL_FILE)

**Example Config Generated (with BDI enabled):**
```json
{
  "metadata": {
    "worker": {
      "bdi_enabled": true,
      "bdi_config": {
        "jid": "agent@localhost",
        "password": "secret",
        "asl_file": "/path/to/beliefs.asl"
      },
      "config": { ... }
    }
  },
  "environment": {
    "BDI_ENABLED": "1",
    "BDI_JID": "agent@localhost",
    "BDI_PASSWORD": "secret",
    "BDI_ASL_FILE": "/path/to/beliefs.asl",
    ...
  }
}
```

### File 2: gym_gui/services/trainer/dispatcher.py

**Changes:**
1. Modified `_build_worker_command()` method after gRPC flag section
   - Checks if `worker_meta.get("bdi_enabled")` is True
   - If BDI enabled, adds to worker command:
     - `--bdi` flag
     - `--bdi-jid <jid>` (reads from bdi_config.jid, default: "agent@localhost")
     - `--bdi-password <password>` (reads from bdi_config.password, default: "secret")
     - `--asl-file <path>` (if bdi_config.asl_file provided)

**Example Worker Command Generated (with BDI):**
```bash
/usr/bin/python -m spadeBDI_RL_refactored.worker \
    --config /var/trainer/configs/abc123def.json \
    --grpc --grpc-target 127.0.0.1:50055 \
    --bdi --bdi-jid agent@localhost --bdi-password secret --asl-file /path/beliefs.asl
```

## Code Quality

**Codacy Analysis Results:**
- `agent_train_dialog.py`: ✅ **0 issues**
- `dispatcher.py`: ✅ **0 issues**

**Design Principles Maintained:**
- ✅ Backward compatible: Q-Learning flow unchanged when BDI unchecked
- ✅ Non-invasive: BDI configuration only populated if checkbox enabled
- ✅ Sensible defaults: Defaults match local XMPP testing setup
- ✅ Follows existing patterns: Uses same config merging, metadata structure
- ✅ No breaking changes: Existing training configs still work (bdi_enabled defaults to False)

## How Users Will Use This

### Scenario 1: Train with Q-Learning (existing behavior)
1. Open "Train Agent" dialog
2. Select environment (FrozenLake-v1)
3. Leave "BDI Agent Settings" **unchecked**
4. Configure hyperparameters (learning_rate, gamma, epsilon_decay)
5. Click OK
6. **Result:** Worker runs with `HeadlessTrainer` (Q-Learning only)

### Scenario 2: Train with BDI Agent (NEW - this fix)
1. Open "Train Agent" dialog
2. Select environment (FrozenLake-v1)
3. **CHECK** "BDI Agent Settings (SPADE)"
4. Fields auto-populate:
   - XMPP JID: `agent@localhost` ✓
   - XMPP Password: `secret` ✓
   - ASL File: (optional, can browse)
5. Configure hyperparameters
6. Click OK
7. **Result:** 
   - Worker receives `--bdi --bdi-jid agent@localhost --bdi-password secret` flags
   - Worker runs with `BDITrainer` (SPADE-based belief-desire-intention agent)
   - Agent connects to XMPP server (ejabberd required)
   - Agent executes SPADE beliefs and desires
   - **AGENT MOVES IN ENVIRONMENT** ✅
   - Telemetry captured and displayed in Live Telemetry tab ✅

## Integration Points

### Training Flow (Updated)
```
UI: TrainAgentDialog
    ↓ _build_base_config()
Config: metadata.worker.bdi_enabled = true/false
Config: metadata.worker.bdi_config = {jid, password, asl_file}
    ↓ SubmitRunRequest(config)
Trainer Service: Stores config in database
    ↓ Dispatcher polls for PENDING runs
Dispatcher: _build_worker_command()
    ↓ Checks worker_meta.bdi_enabled
    ↓ Adds --bdi flags if True
Worker Command: [...--grpc --grpc-target...--bdi --bdi-jid...--bdi-password...]
    ↓ Subprocess spawned
Worker Process: spadeBDI_RL_refactored.worker main()
    ↓ argparse reads --bdi flag (now present!)
    ✓ Instantiates BDITrainer (not HeadlessTrainer)
    ✓ Creates SPADE agent with specified JID
    ✓ Loads ASL beliefs if provided
    ✓ Connects to XMPP server
    ✓ Starts training with belief-desire-intention loop
    ✓ Agent MOVES and makes DECISIONS
    ↓ Telemetry streamed to relay
    ↓ Captured in TelemetrySQLiteStore
    ↓ Displayed in Live Telemetry tab
User: SEES AGENT MOVING ✅
```

## Testing Instructions

### Test 1: Verify UI appears
1. Run `python -m gym_gui.app` (GUI)
2. Click "Train Agent" button
3. **Verify:** "BDI Agent Settings (SPADE)" section appears below "Epsilon Decay"
4. **Verify:** Checkbox is unchecked by default
5. **Verify:** Section is collapsed/disabled until checkbox is checked

### Test 2: Verify BDI config generation
1. In Train Agent dialog:
   - Select "FrozenLake-v1"
   - Select "Q-Learning"
   - Leave other fields as default
   - **CHECK** "BDI Agent Settings (SPADE)"
2. **Verify:** Fields populate with defaults:
   - XMPP JID: `agent@localhost`
   - XMPP Password: `secret` (shown as dots)
3. Click OK
4. **Result:** Training run submitted with BDI enabled

### Test 3: Verify dispatcher adds --bdi flags
1. Start daemon: `python -m gym_gui.services.trainer_daemon`
2. Submit training with BDI enabled (Test 2)
3. In another terminal, check worker process:
   ```bash
   ps aux | grep spadeBDI_RL_refactored.worker
   ```
4. **Verify** worker command includes:
   ```
   --bdi --bdi-jid agent@localhost --bdi-password secret
   ```
5. **Check worker logs** for BDITrainer instantiation:
   ```bash
   tail -100 /home/hamid/Desktop/Projects/GUI_BDI_RL/var/logs/daemon.log | grep -i "bdi\|trainer"
   ```
6. **Verify:** Should see "BDITrainer" not "HeadlessTrainer"

### Test 4: Full integration test (if XMPP server available)
1. Ensure ejabberd XMPP server is running and accepts `agent@localhost:secret`
2. Start daemon
3. Start GUI
4. Train with BDI mode enabled
5. **Verify:** In Live Telemetry tab:
   - Recent Episodes table shows training progress
   - Recent Steps table shows agent actions/observations
   - "Game" column shows "FrozenLake-v1"
   - "Outcome" column shows Success/Failed/Timeout
6. **Critical:** Agent should MOVE in environment (not stuck at starting position)

### Test 5: Q-Learning still works (no regression)
1. Start daemon
2. Start GUI
3. Train with BDI settings **UNCHECKED**
4. **Verify:** Worker command has NO --bdi flags
5. **Verify:** Training runs with HeadlessTrainer (Q-Learning)
6. **Verify:** Telemetry captured (existing behavior unchanged)

## Known Limitations & Future Enhancements

### Current Limitations
1. **XMPP Server Required:** BDI mode requires running ejabberd XMPP server
   - When not available, worker will fail to connect
   - Suitable for local development/testing only
   - Production deployment would need separate XMPP infrastructure

2. **ASL File Optional:** Users must provide ASL beliefs file manually
   - No default ASL template provided
   - File must be valid SPADE ASL syntax
   - Validation only occurs when file is loaded by worker

3. **Fixed XMPP Defaults:** No way to save/load XMPP profiles
   - Must re-enter JID/password each session
   - Future: Could save favorite XMPP configs

### Future Enhancements
1. **XMPP Connection Testing:** "Test Connection" button in BDI settings
   - Validates JID/password before submitting training
   - Provides early feedback if XMPP server unavailable

2. **ASL Template Library:** Pre-built ASL belief templates
   - FrozenLake-optimized beliefs
   - Taxi domain beliefs
   - User-defined belief sets

3. **BDI Config Profiles:** Save/load XMPP configurations
   - "Save Current Settings as Profile"
   - Dropdown to quickly switch between profiles

4. **BDI Monitoring Dashboard:** Real-time belief/desire/intention visualization
   - Show current beliefs (position, goal, obstacles)
   - Show active intentions (plans/goals)
   - Visualize belief updates during training

## Summary

This fix addresses the critical missing link in the training pipeline: **connecting the UI to the BDI mode selection**. 

**What was broken:**
- Training always used HeadlessTrainer (Q-Learning)
- No way to enable BDI mode from UI
- `--bdi` flag never passed to worker

**What was fixed:**
- Added "BDI Agent Settings" section to training dialog
- Checkbox to enable BDI mode with XMPP configuration
- Dispatcher now injects `--bdi` flags when BDI enabled
- Worker receives flags and instantiates BDITrainer

**Expected outcome:**
- User checks "BDI Agent Settings" checkbox
- Submits training
- Worker runs with SPADE-based belief-desire-intention agent
- Agent MOVES in environment
- User SEES training progress in telemetry

**Code quality:** ✅ Codacy 0 issues on both files

## Files Modified

1. `/gym_gui/ui/widgets/agent_train_dialog.py`
   - Added BDI UI section (lines 109-139)
   - Added _on_browse_asl_file() handler (lines 184-191)
   - Updated _build_base_config() with BDI settings (lines 240-265)

2. `/gym_gui/services/trainer/dispatcher.py`
   - Updated _build_worker_command() to inject BDI flags (lines 213-233)
   - Reads bdi_enabled and bdi_config from metadata
   - Adds --bdi, --bdi-jid, --bdi-password, --asl-file flags

Both files pass Codacy analysis with 0 issues.
